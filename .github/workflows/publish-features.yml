name: Publish Devcontainer Features

on:
  pull_request:
    paths:
      - '.devcontainer/features/**'
  push:
    branches: [main]
    paths:
      - '.devcontainer/features/**'
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  FEATURE_REPO: ghcr.io/mrdavidlaing/laingville-devcontainer-ubuntu/features

jobs:
  publish-features:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      matrix:
        feature:
          - laingville-cli-tools

    steps:
      - uses: actions/checkout@v4

      - name: Generate tags
        id: tags
        run: |
          FEATURE_DIR=".devcontainer/features/${{ matrix.feature }}"
          VERSION=$(jq -r '.version' "${FEATURE_DIR}/devcontainer-feature.json")
          DATE=$(date +%Y-%m-%d)
          SHA=$(git rev-parse --short HEAD)
          
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Validate feature
        run: .devcontainer/features/${{ matrix.feature }}/build.sh validate

      - name: Download binaries
        run: .devcontainer/features/${{ matrix.feature }}/build.sh download

      - name: Test binaries
        run: .devcontainer/features/${{ matrix.feature }}/build.sh test

      - name: Package feature
        id: package
        run: |
          .devcontainer/features/${{ matrix.feature }}/build.sh package
          echo "artifact=.devcontainer/features/${{ matrix.feature }}/output/${{ matrix.feature }}.tgz" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install ORAS
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: oras-project/setup-oras@v1

      - name: Publish feature to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          FEATURE_BASE="${{ env.FEATURE_REPO }}/${{ matrix.feature }}"
          VERSION="${{ steps.tags.outputs.version }}"
          DATE="${{ steps.tags.outputs.date }}"
          SHA="${{ steps.tags.outputs.sha }}"
          ARTIFACT="${{ steps.package.outputs.artifact }}"
          
          for TAG in "${VERSION}" "${DATE}" "${DATE}-${SHA}" "latest"; do
            echo "Publishing: ${FEATURE_BASE}:${TAG}"
            oras push "${FEATURE_BASE}:${TAG}" \
              --config /dev/null:application/vnd.devcontainers \
              "${ARTIFACT}:application/vnd.devcontainers.layer.v1+tar"
          done
          
          echo "✓ Feature published"

      - name: Install Cosign
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@v3

      - name: Sign feature
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          FEATURE_BASE="${{ env.FEATURE_REPO }}/${{ matrix.feature }}"
          VERSION="${{ steps.tags.outputs.version }}"
          
          cosign sign --yes "${FEATURE_BASE}:${VERSION}"
          cosign sign --yes "${FEATURE_BASE}:latest"
          echo "✓ Feature signed"

      - name: Install Syft
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate and attach SBOM
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          FEATURE_DIR=".devcontainer/features/${{ matrix.feature }}"
          FEATURE_BASE="${{ env.FEATURE_REPO }}/${{ matrix.feature }}"
          VERSION="${{ steps.tags.outputs.version }}"
          
          syft dir:"${FEATURE_DIR}" -o spdx-json > sbom.spdx.json
          cosign attest --yes --predicate sbom.spdx.json --type spdx "${FEATURE_BASE}:${VERSION}"
          echo "✓ SBOM attached"

      - name: Upload SBOM artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.feature }}
          path: sbom.spdx.json

      - name: Summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          FEATURE_BASE="${{ env.FEATURE_REPO }}/${{ matrix.feature }}"
          VERSION="${{ steps.tags.outputs.version }}"
          
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## Published: ${{ matrix.feature }}
          
          \`\`\`json
          { "features": { "${FEATURE_BASE}:${VERSION}": {} } }
          \`\`\`
          EOF

  test-published-feature:
    needs: publish-features
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Create test config
        run: |
          mkdir -p .devcontainer-test
          cat > .devcontainer-test/devcontainer.json << 'EOF'
          {
            "name": "Feature Test",
            "image": "mcr.microsoft.com/devcontainers/base:1-ubuntu-24.04",
            "features": {
              "ghcr.io/mrdavidlaing/laingville-devcontainer-ubuntu/features/laingville-cli-tools:latest": {}
            }
          }
          EOF

      - name: Start devcontainer
        run: devcontainer up --workspace-folder . --config .devcontainer-test/devcontainer.json

      - name: Test tools
        run: |
          devcontainer exec --workspace-folder . --config .devcontainer-test/devcontainer.json \
            bash -c 'set -e; for t in jq rg fd bat fzf shellcheck shfmt just; do echo -n "$t: "; $t --version | head -1; done; echo "✓ All tools working"'

      - name: Stop devcontainer
        if: always()
        run: |
          CONTAINER_ID=$(docker ps -q --filter "label=devcontainer.local_folder=$PWD")
          if [ -n "$CONTAINER_ID" ]; then
            docker stop "$CONTAINER_ID" || true
            docker rm "$CONTAINER_ID" || true
          fi

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify signature
        run: |
          echo "=== Verifying signature ==="
          cosign verify \
            --certificate-identity-regexp="https://github.com/mrdavidlaing/laingville-devcontainer-ubuntu/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            ghcr.io/mrdavidlaing/laingville-devcontainer-ubuntu/features/laingville-cli-tools:latest
          echo "✓ Signature verified"

      - name: Verify and print SBOM attestation
        run: |
          echo "=== Verifying SBOM attestation ==="
          cosign verify-attestation \
            --type spdx \
            --certificate-identity-regexp="https://github.com/mrdavidlaing/laingville-devcontainer-ubuntu/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            ghcr.io/mrdavidlaing/laingville-devcontainer-ubuntu/features/laingville-cli-tools:latest \
            | jq -r '.payload' | base64 -d | jq '.predicate' > sbom.json
          echo "✓ SBOM attestation verified"
          
          echo ""
          echo "=== SBOM Contents ==="
          jq '.' sbom.json
          
          echo ""
          echo "=== SBOM Package Summary ==="
          jq -r '.packages[]? | "\(.name) \(.versionInfo // "n/a")"' sbom.json || echo "(no packages listed)"

      - name: Test summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## Feature Test: ✓ Passed
          
          **Tools verified:** jq, rg, fd, bat, fzf, shellcheck, shfmt, just
          
          **Supply chain:**
          - ✓ Signature verified (Sigstore/Cosign)
          - ✓ SBOM attestation verified (SPDX format)
          EOF
